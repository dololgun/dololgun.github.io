# redis replication

레플리카가 마스터와 접속이 될 때, 레플리카는 PSYNC커맨드를 수행하여 자신의 레플리케이션ID와 오프셋을 전송한다. 오프셋을 전송하기 때문에 마스터에서는 모든 데이터셋을 전송할 필요 없이 레플리카가 부족한 데이터셋만 전송할 수 있다. 하지만 마스터에 증가분에 대한 버퍼가 없거나 레플리카가 더이상 알지 못하는 레플리케이션ID를 참조하고 있다면 전체 데이터 동기화가 발생한다. 

#### 전체 동기화 발생할 때 시나리오

마스터는 백그라운드에서 데이터셋을 RDB파일로 저장한다. 이와 동시에 클라이언트의 쓰기 명령어는 모두 버퍼에 저장하기 시작한다. 백그라운드 저장이 완료되면 마스터는 데이터베이스 파일을 레플리카로 전송한다. 레플리카는 데이터베이스파일을 로컬 파일에 저장 후 메모리에 로드한다. 그 후 마스터는 버퍼에 저장하였던 모든 쓰기 명령어를 레플리카로 전송한다. 이것은 커맨드 스트림으로 수행되며 레디스의 원래의 통신방식과 동일하다.

## 레플리케이션ID

마스터가 장애에서 재시작하거나 레플리카가 마스터로 승격될 때, 해당 인스턴스에서 레플리케이션ID는 재 생성된다. 마스터에 접속한 레플리카는 이 레플리케이션ID를 상속받는다. 결국 2개의 같은 레플리케이션ID를 가지고 있는 2개의 인스턴스는 동일한 데이터셋을 가지고 있다고 볼수 있다. 하지만 시간상의 차이가 존재하며 그 차이를 알 수 있도록 하기 위해 오프셋이 존재한다. A인스턴스의 오프셋이 1000이고 B인스턴스의 오프셋이 1023이라면 A인스터스는 단지 몇개의 명령어 적용을 통해서 B의 데이터셋과 동일하게 된다. 

레플리카가 마스터로 승격될 때 새로운 레플리케이션ID가 생성된다. 

## 디스크 없는 레플리케이션

일반적으로 전체 재동기화를 위해서는 RDB파일 생성이 필요하고 이를 보관하기 위한 파일저장소가 필요하다. 하지만 느린 파일 저장소에서 이런 작업은 비효율적이다. 레디스 2.8.18에서는 디스크없이 레플리케이션이 가능하도록 지원한다. 이 버전에서 파일의 저장없이 데이터셋이 레플리카에 전송된다. 

## 설정하기

설정은 단순하다. 설정 파일에 다음과 같이 마스터 주소를 설정한다. (redis.conf 파일)

```
replicaof 192.168.1.1 6379
```

또는 REPLICAOF 커맨드를 사용할수 있다. 그러면 마스터가 레플리카와 싱크를 시작할 것이다. 

```
# 레플리카 모드를 해제한다. 
REPLICAOF NO ONE 

# 서버를 레플리카로 변경한다. 
REPLICAOF hostname port
```

REPLICAOF NO ONE 명령어로 레플리카를 마스터로 변경하더라도 레플리케이션이 해제 되는 것은 아니다. 즉, 마스터에 장애가 발생할때 레플리카가 마스터로 승격하는 단계를 이 명령어로 수행할 수 있다. 

## read only replica
레플리카는 기본설정이 읽기 전용이다. 이것은 redis.conf 파일에 `replica-read-only`로 설정되어 있다. 

## 마스터가 인증이 필요한 경우의 설정

```
# 명령어를 이용한 경우 
config set masterauth <password>

# 설정파일을 이용한 경우 
masterauth <password>
```

## 쓰기가 가능하기 위한 최소한의 레플리카 수 

쓰기가 가능하기 위한 최소한의 레플리카의 수 이상의 레플리카가 데이터를 받을 수 있는 상황이되어야 마스터가 쓰기 가능하다. 
```
min-replicas-to-write <number of replicas>
```
그렇다면 레플리카가 정상 인지는 어떻게 판단할 수 있는가? 각 정상적인 상황에서 레플리카는 초마다 마스터에게 PING을 전송하며 마스터는 각 레플리카별로 가장 마지막에 전송한 시각을 기억하고 있다. 결국 마스터는 레플리카가 전송한 가장 마지막 시각으로 부터 다시 전송하기 까지의 지연된 시각을 기준으로 해당 레플리카의 정상여부를 판단할 수 있다. 그리고 지연된 시각의 크기를 설정할 수 있다. 이것이 다음 설정 파라미터 이다. 

```
min-replicas-max-lag 5
```


## Configuring replication in Docker and NAT

도커환경이라면 추가적인 설정이 필요하다. 특히 레디스 센티널이나 레플리카의 주소를 얻기 위해 마스터에서 `INFO`나 `ROLE`명령어를 사용하는 다른 시스템에서 그렇다. 

문제는  `ROLE`명령어와 `INFO`명령어의 replication section에서 발생한다. 이 명령어의 출력에서 보여지는 레플리카의 주소부분인데, 이 부분은 레플리카가 마스터와 접속하기위해 사용하는 IP주소를 보여준다. NAT환경에서 사용되는 이 IP주소는 실제 클라이언트가 접속해야 하는 IP주소와 다르다.  